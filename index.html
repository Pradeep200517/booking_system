// Mock data for slots (simulating API response)
const mockSlots = [
  { date: new Date().toISOString().split('T')[0], time: '09:00 AM', booked: false, name: null, recurrence: null },
  { date: new Date().toISOString().split('T')[0], time: '10:00 AM', booked: false, name: null, recurrence: null },
  { date: new Date().toISOString().split('T')[0], time: '11:00 AM', booked: false, name: null, recurrence: null },
  { date: new Date().toISOString().split('T')[0], time: '02:00 PM', booked: false, name: null, recurrence: null },
];

// Initialize localStorage for users if not already set
if (!localStorage.getItem('users')) {
  localStorage.setItem('users', JSON.stringify([]));
}

let currentUser = null;
let selectedDate = new Date().toISOString().split('T')[0];

function showLogin() {
  document.getElementById('login-form').style.display = 'block';
  document.getElementById('signup-form').style.display = 'none';
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('signup-error').style.display = 'none';
  document.getElementById('login-email').focus();
}

function showSignup() {
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('signup-form').style.display = 'block';
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('signup-error').style.display = 'none';
  document.getElementById('signup-email').focus();
}

function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value.trim();
  const errorElement = document.getElementById('login-error');
  const btn = document.querySelector('#login-form .btn-primary');

  // Reset error display
  errorElement.style.display = 'none';
  btn.disabled = true;
  btn.innerHTML = 'Signing In...';

  // Basic client-side validation
  if (!email || !password) {
    errorElement.textContent = 'Please fill in all fields';
    errorElement.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = 'Sign In';
    document.getElementById('login-email').focus();
    return;
  }

  // Check credentials against localStorage
  const users = JSON.parse(localStorage.getItem('users'));
  const user = users.find(u => u.email === email && u.password === password);

  if (user) {
    currentUser = { name: user.name, email: user.email };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    showApp();
  } else {
    errorElement.textContent = 'Invalid email or password';
    errorElement.style.display = 'flex';
    errorElement.setAttribute('role', 'alert');
    document.getElementById('login-email').focus();
  }

  btn.disabled = false;
  btn.innerHTML = 'Sign In';
}

function handleSignup() {
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value.trim();
  const confirm = document.getElementById('signup-confirm').value.trim();
  const errorElement = document.getElementById('signup-error');
  const btn = document.querySelector('#signup-form .btn-primary');

  // Reset error display
  errorElement.style.display = 'none';
  btn.disabled = true;
  btn.innerHTML = 'Creating Account...';

  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    errorElement.textContent = 'Please enter a valid email address';
    errorElement.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = 'Create Account';
    document.getElementById('signup-email').focus();
    return;
  }

  // Check if all fields are filled
  if (!email || !password || !confirm) {
    errorElement.textContent = 'Please fill in all fields';
    errorElement.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = 'Create Account';
    document.getElementById('signup-email').focus();
    return;
  }

  // Check password match
  if (password !== confirm) {
    errorElement.textContent = 'Passwords do not match';
    errorElement.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = 'Create Account';
    document.getElementById('signup-confirm').focus();
    return;
  }

  // Check password strength
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
  if (!passwordRegex.test(password)) {
    errorElement.textContent =
      'Password must be at least 8 characters long and include uppercase, lowercase, number, and special character';
    errorElement.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = 'Create Account';
    document.getElementById('signup-password').focus();
    return;
  }

  // Check for existing email
  const users = JSON.parse(localStorage.getItem('users'));
  if (users.some(u => u.email === email)) {
    errorElement.textContent = 'Email already exists';
    errorElement.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = 'Create Account';
    document.getElementById('signup-email').focus();
    return;
  }

  // Save new user to localStorage
  users.push({ email, password, name: email.split('@')[0] });
  localStorage.setItem('users', JSON.stringify(users));
  currentUser = { name: email.split('@')[0], email };
  localStorage.setItem('currentUser', JSON.stringify(currentUser));

  // Show success message
  errorElement.textContent = 'Account created successfully!';
  errorElement.style.display = 'flex';
  errorElement.style.backgroundColor = 'rgba(20, 184, 166, 0.1)';
  errorElement.style.color = 'var(--accent)';
  errorElement.setAttribute('role', 'alert');

  setTimeout(() => {
    showApp();
  }, 1500);

  btn.disabled = false;
  btn.innerHTML = 'Create Account';
}

function showApp() {
  document.getElementById('auth-container').style.display = 'none';
  document.getElementById('app-container').style.display = 'block';
  // Add logout button dynamically
  const controls = document.querySelector('.controls');
  const logoutBtn = document.createElement('button');
  logoutBtn.className = 'btn btn-cancel';
  logoutBtn.textContent = 'Logout';
  logoutBtn.setAttribute('aria-label', 'Log out of your account');
  logoutBtn.onclick = handleLogout;
  controls.appendChild(logoutBtn);
  fetchSlots();
}

function handleLogout() {
  currentUser = null;
  localStorage.removeItem('currentUser');
  document.getElementById('app-container').style.display = 'none';
  document.getElementById('auth-container').style.display = 'flex';
  showLogin();
}

function fetchSlots() {
  const container = document.getElementById('slots-container');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

  // Simulate API delay
  setTimeout(() => {
    // Filter slots for the selected date
    let slots = JSON.parse(localStorage.getItem('slots') || JSON.stringify(mockSlots));
    slots = slots.filter(slot => slot.date === selectedDate);
    renderSlots(slots);
  }, 500);
}

function renderSlots(slots) {
  const container = document.getElementById('slots-container');
  container.innerHTML = '';

  slots.forEach((slot, index) => {
    const card = document.createElement('div');
    card.className = `slot-card ${slot.booked ? 'booked' : 'available'}`;
    card.style.animationDelay = `${index * 0.05}s`;
    card.innerHTML = `
      <div class="slot-time">${slot.time}</div>
      <div class="slot-status">${slot.booked ? `Booked by ${slot.name}` : 'Available for booking'}</div>
      <div class="slot-actions">
        ${slot.booked ? `
          <button class="btn btn-cancel" onclick="cancelSlot('${slot.time}')" aria-label="Cancel booking for ${slot.time}">
            Cancel
          </button>
        ` : `
          <input type="text" class="name-input" placeholder="Your full name" id="name-${slot.time}" aria-label="Name for ${slot.time} booking">
          <select class="select-input" id="recurrence-${slot.time}" aria-label="Recurrence for ${slot.time} booking">
            <option value="one-time">One-Time</option>
            <option value="weekly">Weekly</option>
          </select>
          <button class="btn btn-book" onclick="bookSlot('${slot.time}')" aria-label="Book slot for ${slot.time}">
            Book Now
          </button>
        `}
      </div>
    `;
    container.appendChild(card);
  });
}

function bookSlot(time) {
  const nameInput = document.getElementById(`name-${time}`);
  const name = nameInput.value.trim();
  const recurrence = document.getElementById(`recurrence-${time}`).value;

  if (!name) {
    nameInput.focus();
    nameInput.style.borderColor = '#f43f5e';
    setTimeout(() => {
      nameInput.style.borderColor = 'var(--border)';
    }, 1000);
    return;
  }

  const btn = document.querySelector(`button[onclick="bookSlot('${time}')"]`);
  btn.disabled = true;
  btn.innerHTML = 'Booking...';

  // Update slots in localStorage
  let slots = JSON.parse(localStorage.getItem('slots') || JSON.stringify(mockSlots));
  const slotIndex = slots.findIndex(slot => slot.date === selectedDate && slot.time === time);
  if (slotIndex !== -1) {
    slots[slotIndex] = { ...slots[slotIndex], booked: true, name, recurrence };
  } else {
    slots.push({ date: selectedDate, time, booked: true, name, recurrence });
  }

  if (recurrence === 'weekly') {
    bookRecurringSlots(time, name);
  }

  localStorage.setItem('slots', JSON.stringify(slots));

  const card = btn.closest('.slot-card');
  card.style.transform = 'scale(1.05)';
  card.style.boxShadow = '0 16px 32px rgba(20, 184, 166, 0.3)';
  setTimeout(() => {
    card.style.transform = '';
    card.style.boxShadow = '';
    fetchSlots();
    btn.disabled = false;
    btn.innerHTML = 'Book Now';
  }, 500);
}

function bookRecurringSlots(time, name) {
  let slots = JSON.parse(localStorage.getItem('slots') || JSON.stringify(mockSlots));
  const baseDate = new Date(selectedDate);
  for (let i = 1; i <= 3; i++) {
    const newDate = new Date(baseDate.getTime() + i * 7 * 24 * 60 * 60 * 1000);
    const dateStr = newDate.toISOString().split('T')[0];
    const slotIndex = slots.findIndex(slot => slot.date === dateStr && slot.time === time);
    if (slotIndex === -1) {
      slots.push({ date: dateStr, time, booked: true, name, recurrence: 'weekly' });
    } else if (!slots[slotIndex].booked) {
      slots[slotIndex] = { ...slots[slotIndex], booked: true, name, recurrence: 'weekly' };
    }
  }
  localStorage.setItem('slots', JSON.stringify(slots));
}

function cancelSlot(time) {
  if (!confirm('Are you sure you want to cancel this booking?')) {
    return false;
  }

  const btn = document.querySelector(`button[onclick="cancelSlot('${time}')"]`);
  btn.disabled = true;
  btn.innerHTML = 'Cancelling...';

  let slots = JSON.parse(localStorage.getItem('slots') || JSON.stringify(mockSlots));
  const slotIndex = slots.findIndex(slot => slot.date === selectedDate && slot.time === time);
  if (slotIndex !== -1) {
    slots[slotIndex] = { ...slots[slotIndex], booked: false, name: null, recurrence: null };
  }
  localStorage.setItem('slots', JSON.stringify(slots));

  const card = btn.closest('.slot-card');
  card.style.transform = 'scale(0.95)';
  card.style.opacity = '0.7';
  setTimeout(() => {
    card.style.transform = '';
    card.style.opacity = '';
    fetchSlots();
    btn.disabled = false;
    btn.innerHTML = 'Cancel';
  }, 300);

  return true;
}

flatpickr('#date-picker', {
  dateFormat: 'Y-m-d',
  defaultDate: selectedDate,
  onChange: (selectedDates) => {
    selectedDate = selectedDates[0].toISOString().split('T')[0];
    fetchSlots();
  },
});

// Initialize
showLogin();
